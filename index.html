<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Device-Motion-Cube (gleiche Höhe wie Kamera)</title>
  <style>
    body{margin:0;overflow:hidden;background:#000}
    canvas{display:block}
    #info,#orient{
      position:absolute;left:0;width:100%;text-align:center;
      font-family:sans-serif;color:#fff;z-index:10;background:rgba(0,0,0,.7);padding:10px
    }
    #info{top:0}
    #orient{bottom:0;font-size:.8rem}
  </style>
</head>
<body>
  <div id="info">Tippe, um Bewegungssensor-Zugriff zu erlauben v101</div>
  <div id="orient"></div>

  <script type="module">
    /* ---------- Three.js import ------------------------------------------ */
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';

    /* ---------- Grund-Setup ---------------------------------------------- */
    const scene   = new THREE.Scene();

    const camera  = new THREE.PerspectiveCamera(
      75, innerWidth/innerHeight, 0.1, 1000
    );
    camera.position.z = 3;

    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(innerWidth, innerHeight);
    document.body.appendChild(renderer.domElement);

    /* ---------- Bunter Würfel ------------------------------------------- */
    const cubeMaterials = [
      0xff0000, 0x00ff00, 0x0000ff, 0xffff00, 0xff00ff, 0x00ffff
    ].map(c => new THREE.MeshBasicMaterial({ color:c }));

    const cube = new THREE.Mesh(new THREE.BoxGeometry(), cubeMaterials);
    scene.add(cube);

    /* ---------- Eigenes DeviceOrientation-Handling ----------------------- */
    const zee     = new THREE.Vector3(0,0,1);      // Referenz-Z-Achse
    const euler   = new THREE.Euler();             // αβγ → Euler
    const qScreen = new THREE.Quaternion();        // Bildschirm-Rotation
    const qCam    = new THREE.Quaternion();        // End-Quaternion
    const deg2rad = Math.PI / 180;

    function onDeviceOrientation(evt){
      const { alpha, beta, gamma } = evt;
      if(alpha === null) return;                    // keine Daten (Desktop)

      /* 1. Euler (Reihenfolge Z-X-Y laut W3C-Spec) */
      euler.set(beta*deg2rad, gamma*deg2rad, -alpha*deg2rad, 'ZXY');

      /* 2. Quaternion aus Euler */
      qCam.setFromEuler(euler);

      /* 3. Bildschirm-Ausrichtung (Portrait/Landscape) einrechnen */
      const so = screen.orientation?.angle || window.orientation || 0;
      qScreen.setFromAxisAngle(zee, -so*deg2rad);
      qCam.multiply(qScreen);

      camera.quaternion.copy(qCam);
    }

    /* ---------- Render-Loop --------------------------------------------- */
    function loop(){
      requestAnimationFrame(loop);

      /* Der Würfel folgt der Kamera-Höhe (Y-Achse) */
      cube.position.y = camera.position.y;

      renderer.render(scene, camera);
    }

    /* ---------- Portrait/Landscape-Label -------------------------------- */
    const orientLabel = document.getElementById('orient');
    function updateOrientLabel(){
      orientLabel.textContent =
        matchMedia('(orientation:portrait)').matches ?
        'Portrait-Modus' : 'Landscape-Modus';
    }
    updateOrientLabel();

    /* ---------- Resize & Orientation-Events ----------------------------- */
    function handleResize(){
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    }

    addEventListener('resize', handleResize);
    addEventListener('orientationchange', () => {
      updateOrientLabel();
      handleResize();
      /* Controls neu synchronisieren:  einmal connecten reicht,
         weil wir den Sensor direkt auswerten                        */
    });

    /* ---------- iOS 13+ Permission-Flow ------------------------------- */
    const info = document.getElementById('info');

    async function requestAndStart(){
      if(typeof DeviceOrientationEvent?.requestPermission === 'function'){
        try{
          const res = await DeviceOrientationEvent.requestPermission();
          if(res !== 'granted'){ info.textContent='Bewegungszugriff verweigert.'; return; }
        }catch(e){ info.textContent='Berechtigungs-Fehler: '+e; return; }
      }
      info.style.display='none';
      window.addEventListener('deviceorientation', onDeviceOrientation, true);
      loop();
    }

    /* Erste Benutzer-Interaktion abwarten (Pflicht für iOS) */
    ['click','touchstart'].forEach(ev =>
      document.body.addEventListener(ev, requestAndStart, { once:true })
    );
  </script>
</body>
</html>
